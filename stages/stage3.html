<!-- Styling of the page -->
<style type="text/css">
    #stage3-drawingBoard
    {
       width: 400px;
       height:400px;
       border: solid 1px black;
       position: relative;
       margin: 0 auto 0 auto;
    }
    .point{
        width:20px;
        height:20px;
        border-radius: 50%;
        position: absolute;
    }
    .point span{
	    font-size: 0.7em;
	    margin: 0px 0 0 24px;
	    white-space: nowrap;
    }
    .dot-initial{
    	color: #000000;
	    background-color: #ffffff;
    }
    .referencepoint{
        width:20px;
        height:20px;
        border-radius: 50%;
        position: absolute;
    }
    .referencepoint span{
	    font-size: 0.7em;
	    margin: 0px 0 0 24px;
	    white-space: nowrap;
	    overflow: visible;
    }
    #reference{
	    background-color: black;
	    color: black;
	    top:190px;
	    left:190px;
	    z-index:50;
    }
    .stage3-myCompanyName{
	    font-weight: bold;
	    text-transform: uppercase;
    }
    .ui-dialog {
	    z-index: 3000;
    }
    #stage3-newCompetitor{
	    color: #000000;
    }
    #stage3-newCompetitorButton{
    }
    #stage3-drawingHelp{
    	bottom: 0;
    	left: 0;
    	position: absolute;
	    height: 200px;
	    width: 200px;
    }
    .stage3-drawing-corner{
        height: 50px;
    	width: auto;
	    color: #474747;
	    background-color: #B2B2B2 !important;
	    font-size: 0.8em;
	    bottom: 0;
	    left: 0;
        position: relative;
        display: block;
        *display: inline-block;
    }
    .stage3-drawing-line{
        margin-left: 140px;
	    width: 50px;
	    height: 130px;
        display: block;
        position: relative;
        *display: inline-block;
    }
    .stage3-remove-button {
        color: #990000;
    }
    .stage3-button-margin {
	    margin: 5px 15px;
    }
    button.ui-button.ui-widget.ui-state-default.ui-corner-all.ui-button-icon-only.ui-dialog-titlebar-close{
	    display: none;
    }
    #tabling {
	    padding-top: 80px;
    }
    .navbar.navbar-default{
	    background-image: none;
	    background-color:transparent;
	    border: none;
	    box-shadow: none;
	    -webkit-box-shadow: none;
    }
</style>
<!-- Dialog Message Area -->
<div id="stage3-dialog-message-proceed">
  <p>
    <div id="S3P1" class="textreplace"></div>
  </p>
</div>
<div id="stage3-dialog-message-error">
  <p>
    <div id="S3P14" class="textreplace"></div>
  </p>
</div>
<!-- Content of the page -->
<nav class="navbar navbar-default navbar-fixed-top">
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
			<p><div id="S3P2A" class="textreplace"></div><span class="stage3-myCompanyName"></span><div id="S3P2B" class="textreplace"></div><span class="stage3-myCompanyName"></span><div id="S3P2C" class="textreplace"></div></p>
		</div>
	</div>
</nav>
<div class="row">
	<div class="col-md-8 col-md-offset-2">
		<div id="stage3-drawingBoard">
			<div id="stage3-drawingHelp" style="display: none;">
                <svg class="stage3-drawing-line">
				  <line x1="0" y1="125" x2="50" y2="0" style="stroke:rgb(84,84,84);stroke-width:2" />
				</svg>
                <div class="stage3-drawing-corner"><div id="S3P13" class="textreplace"></div></div>
			</div>
			<div class="referencepoint" id="reference"><span class="stage3-myCompanyName"></span></div>
		</div>
	</div>
</div>
<div class="row">
    <div class="col-md-8 col-md-offset-2" id="stage3-delete-buttons">
        <!-- Add the delete competitor button -->
    </div>
</div>
<form id="stage3-form">
<div class="row">
	<div class="col-md-8 col-md-offset-2">
		<p class="form-group">
			<label for="stage3-newCompetitor"><div id="S3P3" class="textreplace"></div></label>
			<input type="text" class="form-control" id="stage3-newCompetitor" name="stage3-newCompetitor">
		</p>
		<button class="btn btn-success" id="stage3-newCompetitorButton"><div id="S3P4" class="textreplace"></div></button>
		
	</div>
</div>
<div class="row" id="stage3-next">
</div>
</form>
<!-- Script of the page -->
<script type="text/javascript">
languageReplace();

//Form placeholder text
$("#stage3-newCompetitor").attr("placeholder",languageReplacement['S3P11']);
$("#stage3-dialog-message").attr("title",languageReplacement['S3P12']);

$( document ).ready(function() {

    //Set color palette
    var colorPaletteAlt = colorPalette.slice();

	//Setting the validation script
	jQuery.validator.setDefaults({
	  debug: true,
	  success: "valid"
	});
	
	//New validation method to identify a unique competitor name
	jQuery.validator.addMethod(
		"uniqueCompanyName",
		function(value, element){
			return checkValueNotInPointData(value);
		},
		languageReplacement['S3P5']
	);

	//Display my company name in the center of the div box
	$(".stage3-myCompanyName").append(mycompanydata[0]);

	//Upon clicking the "Add Competitor" button, actions to be carried out
	$("#stage3-newCompetitorButton").click(function(){

		//Ensure that the competitor field is filled and no repeat in names
		$("#stage3-form").validate();
		
		$("#stage3-newCompetitor").rules("add", {
			required: true,
			minlength: 2,
			uniqueCompanyName: true,
			messages: {
	            //required: languageReplacement['S3P6'],
	            minlength: jQuery.validator.format(languageReplacement['S3P7']),
	            uniqueCompanyName: jQuery.validator.format(languageReplacement['S3P8'])
	        }
		});
		
		//If the competitor name is valid, create the dot
		if(($("#stage3-newCompetitor").val() != "") && checkValueNotInPointData($("#stage3-newCompetitor").val())){

			//Add help box which will fade out in 10s
			$("#stage3-drawingHelp").fadeIn(200);
			$("#stage3-drawingHelp").delay(10000).fadeOut(400);

			//Get a random color from the colorPalette
            if((colorPaletteAlt.length == 0)){
                colorPaletteAlt = colorPalette.slice();
            }
            
			var randomNumber = Math.floor(Math.random() * parseInt(colorPaletteAlt.length));
			
            //Create the entry into the box
			var pointdataPosition = competitorNumber;
            
            lastZindex = lastZindex + 1;
			competitorNumber = competitorNumber + 1;
			
			var positionX = 190;
			var positionY = 190;
			
			//OLD Code, change in position when created
			//var positionX = 190 - (competitorNumber * 10);
			//var positionY = 190 - (competitorNumber * 10);
			
			//Create the entry into the box CONTINUE
			$("#stage3-drawingBoard").append("<div class='point' id='point-"+pointdataPosition+"' style='background-color:"+colorPaletteAlt[randomNumber]+";top:"+positionY+"px;left:"+positionX+"px;z-index:"+lastZindex+";' name='"+$("#stage3-newCompetitor").val()+"'><span class='dot-initial'>" + $("#stage3-newCompetitor").val() + "</span></div>");
			
			//Create entry into the remove competitor area
            if(pointdataPosition == 0){
                $("#stage3-delete-buttons").append('<br><p>'+languageReplacement['S3P15']+'</p>');
            }
            
			$("#stage3-delete-buttons").append("<button class='btn btn-default stage3-button-margin' id='removeButton-"+pointdataPosition+"'>"+$("#stage3-newCompetitor").val()+"&nbsp;<span class='glyphicon glyphicon-remove-circle stage3-remove-button'></button>");
			
			//Enable the remove buttons
			stage3EnableRemoveButton(pointdataPosition);
			
			//Insert value into the list of competitor array ["competitor", "color",[x location,y location]]
			var pointlocationXY = $("#point-"+pointdataPosition).offset();
			var fixedX = parseInt(pointlocationXY.left);
			var fixedY = parseInt(pointlocationXY.top);
			pointdata.push([$("#stage3-newCompetitor").val(), colorPaletteAlt[randomNumber],[0,0],[0,0]]);
			debug("add new pointdata debug: "+pointdata);
            debug("pointdataPosition is "+pointdataPosition);
			
			//Remove color from colorPaletteAlt to prevent repeats
			colorPaletteAlt.splice(randomNumber,1);	
			
			//Empty the input box
			$("#stage3-newCompetitor").val('');
			
			//Make draggable
			$(function() {
				var opt = {
					cursor: "move",
					containment: "parent",
					scroll: false,
					drag: function() {
						$(this).find('span').removeClass("dot-initial");
						var offset = $(this).offset();
			            var xPos = parseInt(offset.left) - fixedX;
			            var yPos = parseInt(offset.top) - fixedY;
			            var pointid = parseInt($(this).attr("id").replace(/point-/,''),10);
                        debug("point data is "+pointid);
                        
                        var getDraggableDotName = $(this).attr('name');
                        for(var draggableCounter in pointdata){
	                        if(pointdata[draggableCounter][0] == getDraggableDotName){
		                        pointdata[draggableCounter][3] = [xPos, yPos];
	                        }
                        }
					}
				};
				$(".point").draggable(opt);
			});
			
			//If competitor added is at least 2, add the next page button
			if(competitorNumber == 2){
				$("#stage3-next").append("<div class='col-md-8 col-md-offset-2'><center>"+languageReplacement['S3P9']+"<br><br><button class='btn btn-success' id='nextPage'>"+languageReplacement['S3P10']+"</button></center></div>");
				
				//Enable next page function
				$("#nextPage").click(function(){
				
					//IF non of the points were moved, DO NOT proceed
					if(checkPointDataChanges()){
						$( "#stage3-dialog-message-proceed" ).dialog( "open" );
						$("#nextPage").empty();
						$("#nextPage").append('<span class="glyphicon glyphicon-cog next-rotation-animate"></span> Loading');
					}else{
						$( "#stage3-dialog-message-error" ).dialog( "open" );
					}
					
				});
			}
	
		}
	});
	
	//Dialog function
	$(function() {
		$( "#stage3-dialog-message-proceed" ).dialog({
			autoOpen: false,
			modal: true,
			buttons: {
				Yes: function() {
					$(this).dialog( "close" );
					stageCurrentStage++;
					runStage(stages[stageCurrentStage]);
				},
				No: function(){
					$(this).dialog( "close" );
				}
			},
			beforeClose: function(){
				$("#nextPage").empty();
				$("#nextPage").append(languageReplacement['S3P10']);
			}
		});
	});
	$(function() {
		$( "#stage3-dialog-message-error" ).dialog({
			autoOpen: false,
			modal: true,
			buttons: {
				Yes: function() {
					$(this).dialog( "close" );
				}
			}
		});
	});

	function stage3EnableRemoveButton(PositionDataPoint){
		
		debug("stage3 - stage3EnableRemoveButton() is running on: "+PositionDataPoint);
		
		$("#removeButton-"+PositionDataPoint).one("click",function(){
			
			var NameOfCompetitorPoint = $("#point-"+PositionDataPoint).attr('name');
			
			for(var stage3LoopPointDataRemoveIndex in pointdata){
				debug("stage3 - stage3EnableRemoveButton() looping: "+stage3LoopPointDataRemoveIndex);
				if(pointdata[stage3LoopPointDataRemoveIndex][0] == NameOfCompetitorPoint){
					pointdata.splice(stage3LoopPointDataRemoveIndex,1);
					debug(pointdata);
                    $("#point-"+PositionDataPoint).remove();
			        $("#removeButton-"+PositionDataPoint).remove();
				}
				
			}
		});
		
	}			
	
	function checkPointDataChanges(){
		
		var maxLoop = competitorNumber;
		var setReturnValue = true;
		
        debug("pointdata is "+pointdata);
        
		for(var LoopCounter = 0; LoopCounter <= maxLoop; LoopCounter++){
			
            if(!(pointdata[LoopCounter])){
                //DO NOTHING
            }else{
                debug('X: '+pointdata[LoopCounter][3][0].toString()+' Y: '+pointdata[LoopCounter][3][1].toString());
                if((pointdata[LoopCounter][3][0] == 0) && (pointdata[LoopCounter][3][1] == 0)){
                    setReturnValue = false;
                }
            }
		}
		
		return setReturnValue;
	}

});
</script>